{{>_ajaxHelpers}}

<script>

    function initNavBar() {
        $(".navbar-burger").click(function() {
            // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
            $(".navbar-burger").toggleClass("is-active");
            $(".navbar-menu").toggleClass("is-active");
        });
    }

    function getWorkers() {
        return getAjax('/cherry/api/runner/list', {}, {})
    }

    function getWorker(workerName) {
        return getAjax(`/cherry/api/runner/detail?name=${workerName}`, {}, {})
    }

    function getTemplate(templateName) {
        return getAjax(`/templates/${templateName}`, "", {contentType: 'text/plain', dataType: "html"})
    }

    function stopRunner(runnerName) {
        return putAjax(`/cherry/api/runner/stop?name=${runnerName}`, "", {contentType: 'text/plain', dataType: "html"})
    }

    function startRunner(runnerName) {
        return putAjax(`/cherry/api/runner/start?name=${runnerName}`, "", {contentType: 'text/plain', dataType: "html"})
    }

    function onWorkerClick(table) {

        return function(e) {
            let runnerName = table.row(this).data().runnerName;
            window.location = "/worker?runnerName="+runnerName;
        }
        /* Old code for displaying in modal popup
        return function(e) {
            let workerName = table.row(this).data().runnerName;
            getWorker(workerName).then(function (worker) {
                getTemplate("_workerDetail.mustache").then(function(template){
                    let html = Mustache.render(template, {worker: worker});
                    $('#workerModal .modal-card .modal-card-head .modal-card-title .title').html(worker.name);
                    $('#workerModal .modal-card .modal-card-head .modal-card-title .subtitle').html(worker.className);
                    $('#workerModal .modal-card .modal-card-body').html(html);
                    $('#workerModal').addClass("is-active");
                });
            });
        }*/
    }

    function initWorkersTable() {
        let data = [];
        getWorkers().then(function(result) {
            if(result) {
                for(const k in result) {
                    console.log("worker detected");
                    let worker = result[k];
                    data.push ({
                        runnerName: worker.name,
                        runnerType: worker.type,
                        runnerTypeRunner: worker.typeRunner,
                        runnerClassName: worker.className,
                        runnerActive: worker.active,
                        runnerLogo: worker.logo
                    })
                }

                let table = $('#runnersTable').DataTable({
                    data: data,
                    columns: [
                        {
                            data: 'runnerName',
                            render: function (data, type, row) {
                              if(row.runnerLogo) {
                                  return '<img width="30px" src="' + row.runnerLogo +'"></img>&nbsp;&nbsp; ' + data;
                              } else {
                                return data;
                              }

                            }
                        },
                        {data: 'runnerType'},
                        {data: 'runnerTypeRunner'},
                        {data: 'runnerClassName'},
                        {data: 'runnerActive'}
                    ]
                });

                $('.dataTable').on('click', 'tbody tr', onWorkerClick(table));
            }

        });
    }
</script>
